<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© - Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'arabic': ['Noto Sans Arabic', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Arabic', Arial, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .agent-card { transition: all 0.3s ease; }
        .agent-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">ğŸ›ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©</h1>
                    <p class="text-blue-100 mt-2">Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±</p>
                </div>
                <div class="text-right">
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg px-4 py-2">
                        <div class="text-sm">Ø§Ù„Ø­Ø§Ù„Ø©: <span id="systemStatus" class="font-semibold">ğŸ”„ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...</span></div>
                        <div class="text-xs mt-1" id="agentStatus">Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡: Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...</div>
                    </div>
                        <div class="text-xs mt-1" id="agentStatus">Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-6 py-8 max-w-6xl">
        
        <!-- Agent Selection -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ¤– Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Explanation Agent -->
                <div class="agent-card bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-lg p-6 cursor-pointer" onclick="selectAgent('explanation')">
                    <div class="text-center">
                        <div class="text-4xl mb-4">ï¿½</div>
                        <h3 class="text-xl font-bold text-blue-800 mb-3">Ø´Ø±Ø­ Ø§Ù„Ø¹Ù‚ÙˆØ¯</h3>
                        <p class="text-blue-700 text-sm mb-4">ÙŠÙ‚ÙˆÙ… Ø¨Ø´Ø±Ø­ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…ÙÙ‡ÙˆÙ…Ø© ÙˆØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
                        <div class="bg-blue-200 text-blue-800 px-3 py-1 rounded-full text-xs">ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ø§Ø¯Ø«Ø©</div>
                    </div>
                </div>

                <!-- Assessment Agent -->
                <div class="agent-card bg-gradient-to-br from-yellow-50 to-yellow-100 border-2 border-yellow-200 rounded-lg p-6 cursor-pointer" onclick="selectAgent('assessment')">
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸ“Š</div>
                        <h3 class="text-xl font-bold text-yellow-800 mb-3">ØªÙ‚ÙŠÙŠÙ… ÙˆØªÙˆØµÙŠØ§Øª</h3>
                        <p class="text-yellow-700 text-sm mb-4">ÙŠØ­Ù„Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙŠÙ‚Ø¯Ù… ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ Ù…Ø¹ ØªÙˆØµÙŠØ§Øª Ù„Ù„ØªØ­Ø³ÙŠÙ† ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø·Ø±Ø§Ù</p>
                        <div class="bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full text-xs">ØªÙ‚ÙŠÙŠÙ… ÙˆØªÙˆØµÙŠØ§Øª</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø£Ø¹Ù„Ø§Ù‡</p>
                <div id="selectedAgentDisplay" class="mt-2 text-lg font-semibold text-blue-600"></div>
            </div>
        </div>

        <!-- Image Upload Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“¸ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù‚Ø¯</h2>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" id="dropZone">
                <div class="mb-4">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <div class="mt-4">
                        <p class="text-lg text-gray-600">ğŸ“„ Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ù‡Ù†Ø§</p>
                        <p class="text-sm text-gray-500 mt-2">Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</p>
                        <p class="text-xs text-gray-400 mt-1">Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: JPG, PNG, PDF | Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 10MB</p>
                    </div>
                    <input type="file" id="imageInput" accept="image/*,.pdf" class="hidden" onchange="handleImageUpload(event)">
                    <button onclick="document.getElementById('imageInput').click()" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                        ğŸ—‚ï¸ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
                    </button>
                </div>
            </div>
            
            <!-- Image Preview -->
            <div id="imagePreview" class="hidden mt-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">ğŸ“· Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©</h3>
                        <button onclick="clearImage()" class="text-red-600 hover:text-red-800 font-medium">
                            âŒ Ø¥Ø²Ø§Ù„Ø©
                        </button>
                    </div>
                    <div class="flex flex-col lg:flex-row gap-4">
                        <div class="lg:w-1/2">
                            <img id="previewImage" class="w-full h-64 object-contain border rounded-lg bg-white" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¹Ù‚Ø¯">
                        </div>
                        <div class="lg:w-1/2">
                            <div class="bg-white rounded-lg p-4 h-64 flex items-center justify-center">
                                <button onclick="processImage()" id="processBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 text-lg">
                                    ğŸ”„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- OCR Progress -->
            <div id="ocrProgress" class="hidden mt-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="loading-spinner mr-4"></div>
                        <div>
                            <h3 class="text-lg font-semibold text-blue-800">ğŸ”„ Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...</h3>
                            <p class="text-blue-600 text-sm mt-1" id="ocrStatus">Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="bg-blue-200 rounded-full h-2">
                            <div id="ocrProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Input -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¹Ù‚Ø¯</h2>
            <textarea id="contractText" class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" placeholder="Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¹Ù‚Ø¯ Ù‡Ù†Ø§...

Ù…Ø«Ø§Ù„:
Ø¹Ù‚Ø¯ Ø¹Ù…Ù„ Ø¨ÙŠÙ† Ø´Ø±ÙƒØ© Ø§Ù„Ù†ÙŠÙ„ Ù„Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø© (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„) ÙˆØ§Ù„Ø³ÙŠØ¯ Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø­Ø³Ù† (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ) Ø¨ÙˆØ¸ÙŠÙØ© Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø£ÙˆÙ„ Ø¨Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ Ù‚Ø¯Ø±Ù‡ 18000 Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ..."></textarea>
            <div class="mt-4 flex justify-between items-center">
                <div class="text-sm text-gray-500" id="charCount">0 Ø­Ø±Ù</div>
                <button onclick="analyzeContract()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200 disabled:opacity-50" id="analyzeBtn">
                    ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingDiv" class="hidden bg-white rounded-lg shadow-lg p-8 mb-8">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h3 class="text-xl font-semibold text-gray-700">Ø¬Ø§Ø±Ù ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯...</h3>
                <p class="text-gray-500 mt-2">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ùˆ Ø£ÙƒØ«Ø±</p>
                <div class="mt-4">
                    <div class="bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h2>
            <div id="resultsContent"></div>
        </div>

        <!-- Chat with Explanation Agent -->
        <div id="chatSection" class="hidden bg-white rounded-lg shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ’¬ Ø§Ø³Ø£Ù„ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø¯</h2>
            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-blue-800 text-sm">
                    <strong>ğŸ’¡ Ø£Ù…Ø«Ù„Ø© Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ø±Ø­Ù‡Ø§:</strong><br>
                    â€¢ Ù…Ø§ Ù…Ø¹Ù†Ù‰ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø±Ø§ØªØ¨ØŸ<br>
                    â€¢ Ø§Ø´Ø±Ø­ Ù„ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø·Ø±ÙÙŠÙ†<br>
                    â€¢ Ù…Ø§ Ù‡ÙŠ Ø­Ù‚ÙˆÙ‚ÙŠ ÙƒÙ…ÙˆØ¸ÙØŸ<br>
                    â€¢ Ù…Ø§ Ù…Ø¹Ù†Ù‰ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¯Ø§Ø¦Ù…ØŸ
                </p>
            </div>
            
            <!-- Chat Messages -->
            <div id="chatMessages" class="bg-gray-50 border rounded-lg p-4 mb-4 max-h-96 overflow-y-auto">
                <div class="text-center text-gray-500 text-sm">
                    Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ³ÙŠØ¬ÙŠØ¨Ùƒ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„...
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="flex gap-3">
                <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." 
                       class="flex-1 p-3 border border-gray-300 rounded-lg text-right"
                       onkeypress="if(event.key==='Enter') askQuestion()">
                <button onclick="askQuestion()" id="askButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition duration-200">
                    â“ Ø§Ø³Ø£Ù„
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <h3 class="text-lg font-semibold mb-2">ğŸ›ï¸ Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©</h3>
            <p class="text-gray-400 text-sm">Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ | AWS Bedrock | AgentCore</p>
            <div class="mt-4 text-xs text-gray-500">
                <p>ØªØ·ÙˆÙŠØ±: Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</p>
            </div>
        </div>
    </footer>

    <script>
        // Production API endpoint
        const API_BASE_URL = 'https://820uxym01d.execute-api.us-west-2.amazonaws.com/prod';
        
        let selectedAnalysisType = '';
        
        // Character count
        document.getElementById('contractText').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('charCount').textContent = count + ' Ø­Ø±Ù';
        });
        
        // System status check
        async function checkSystemStatus() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch(`${API_BASE_URL}/health`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('systemStatus').innerHTML = 'âœ… Ù…ØªØµÙ„';
                    document.getElementById('agentStatus').innerHTML = 'Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡: Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ù…Ù„';
                } else {
                    document.getElementById('systemStatus').innerHTML = 'âš ï¸ Ù…ØªØ§Ø­ Ø¬Ø²Ø¦ÙŠØ§Ù‹';
                    document.getElementById('agentStatus').innerHTML = 'Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡: Ù…Ø­Ø¯ÙˆØ¯Ø©';
                }
            } catch (error) {
                console.log('Status check failed:', error.message);
                document.getElementById('systemStatus').innerHTML = 'âŒ ØºÙŠØ± Ù…ØªØµÙ„';
                document.getElementById('agentStatus').innerHTML = 'Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡: ØºÙŠØ± Ù…ØªØ§Ø­Ø©';
            }
        }
        
        // Image upload and OCR functions
        let selectedImageFile = null;
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                alert('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                return;
            }
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© JPG Ø£Ùˆ PNG Ø£Ùˆ Ù…Ù„Ù PDF');
                return;
            }
            
            selectedImageFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        function clearImage() {
            selectedImageFile = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('ocrProgress').classList.add('hidden');
        }
        
        async function processImage() {
            if (!selectedImageFile) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (!selectedAnalysisType) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰');
                return;
            }
            
            // Show progress
            document.getElementById('ocrProgress').classList.remove('hidden');
            document.getElementById('processBtn').disabled = true;
            
            // Update progress
            updateOCRProgress(10, 'ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64...');
            
            try {
                // Convert image to base64
                const base64Data = await fileToBase64(selectedImageFile);
                updateOCRProgress(30, 'Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...');
                
                // Prepare request payload using the analysis type selected at the top
                const payload = {
                    image_data: base64Data,
                    auto_analyze: true,  // Always auto-analyze since type is selected
                    analysis_type: selectedAnalysisType  // Use the selected type from top
                };
                
                updateOCRProgress(50, 'Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©...');
                
                // Call OCR API with timeout and better error handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
                
                const response = await fetch(`${API_BASE_URL}/api/ocr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                updateOCRProgress(80, 'Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬...');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    updateOCRProgress(100, 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!');
                    
                    // Set extracted text in the textarea
                    document.getElementById('contractText').value = result.extracted_text;
                    document.getElementById('charCount').textContent = result.extracted_text.length + ' Ø­Ø±Ù';
                    
                    // Show success message
                    showOCRSuccess(result);
                    
                    // If auto-analysis was performed, show results
                    if (result.analysis) {
                        displayAnalysisResults(result.analysis);
                    }
                    
                    // Hide progress after 2 seconds
                    setTimeout(() => {
                        document.getElementById('ocrProgress').classList.add('hidden');
                    }, 2000);
                    
                } else {
                    throw new Error(result.error || 'ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©');
                }
                
            } catch (error) {
                console.error('OCR Error:', error);
                
                let errorMessage = 'ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${error.message}`;
                } else {
                    errorMessage = error.message || errorMessage;
                }
                
                updateOCRProgress(0, `Ø®Ø·Ø£: ${errorMessage}`);
                alert(errorMessage);
                
                setTimeout(() => {
                    document.getElementById('ocrProgress').classList.add('hidden');
                }, 3000);
            } finally {
                document.getElementById('processBtn').disabled = false;
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        function updateOCRProgress(percentage, status) {
            document.getElementById('ocrProgressBar').style.width = percentage + '%';
            document.getElementById('ocrStatus').textContent = status;
        }
        
        function showOCRSuccess(result) {
            // Create a success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="text-xl mr-2">âœ…</span>
                    <div>
                        <h4 class="font-bold">ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­!</h4>
                        <p class="text-sm">Ø§Ø³ØªÙØ®Ø±Ø¬ ${result.extracted_text.length} Ø­Ø±Ù Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        function displayAnalysisResults(analysisResult) {
            // This function will handle displaying analysis results from OCR
            if (analysisResult.success) {
                const resultsContent = document.getElementById('resultsContent');
                displayStructuredAnalysis(analysisResult.result, {
                    analysis_type: analysisResult.analysis_type,
                    source: 'ocr_image'
                });
                document.getElementById('results').classList.remove('hidden');
            }
        }
        
        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('imageInput').files = files;
                    handleImageUpload({target: {files: files}});
                }
            });
        });
        
        // Agent selection
        function selectAgent(type) {
            selectedAnalysisType = type;
            
            // Reset all cards
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('ring-4', 'ring-blue-500', 'ring-yellow-500', 'ring-green-500');
            });
            
            // Highlight selected card
            const selectedCard = event.currentTarget;
            if (type === 'explanation') {
                selectedCard.classList.add('ring-4', 'ring-blue-500');
                document.getElementById('selectedAgentDisplay').textContent = 'âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: Ø´Ø±Ø­ Ø§Ù„Ø¹Ù‚ÙˆØ¯';
            } else if (type === 'assessment') {
                selectedCard.classList.add('ring-4', 'ring-yellow-500');
                document.getElementById('selectedAgentDisplay').textContent = 'âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ØªÙ‚ÙŠÙŠÙ… ÙˆØªÙˆØµÙŠØ§Øª';
            }
        }
        
        // Contract analysis
        async function analyzeContract() {
            const contractText = document.getElementById('contractText').value.trim();
            const loadingDiv = document.getElementById('loadingDiv');
            const results = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            
            // Store data for chat functionality
            currentContractText = contractText;
            currentUserId = 'web_user_' + Date.now();
            
            if (!selectedAnalysisType) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (!contractText) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¹Ù‚Ø¯');
                return;
            }
            
            // Show loading
            loadingDiv.classList.remove('hidden');
            results.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        analysis_type: selectedAnalysisType,
                        contract_text: contractText,
                        user_id: 'web_user_' + Date.now()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store session data for chat
                    currentSessionId = result.session_id;
                    
                    // Parse the actual analysis content from the agent response
                    let analysisData;
                    try {
                        // The Lambda function now returns clean structured data in result.result
                        analysisData = result.result;
                    } catch (parseError) {
                        console.error('Failed to parse analysis data:', parseError);
                        analysisData = { error: 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ³ØªÙ„Ù…Ø© Ù…Ù† Ø§Ù„ÙˆÙƒÙŠÙ„' };
                    }
                    
                    displayStructuredAnalysis(analysisData, {
                        agent_name: 'Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯',
                        analysis_type: result.analysis_type,
                        session_id: result.session_id
                    });
                    results.classList.remove('hidden');
                } else {
                    resultsContent.innerHTML = `
                        <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                            <h4 class="font-bold text-red-800">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h4>
                            <p class="mt-2">${result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹'}</p>
                        </div>
                    `;
                    results.classList.remove('hidden');
                }
                
            } catch (error) {
                resultsContent.innerHTML = `
                    <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                        <h4 class="font-bold text-red-800">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</h4>
                        <p class="mt-2">ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
                        <p class="text-sm mt-1">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£: ${error.message}</p>
                    </div>
                `;
                results.classList.remove('hidden');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }
        
        // Display structured analysis
        function displayStructuredAnalysis(data, metadata = {}) {
            const resultsContent = document.getElementById('resultsContent');
            
            // Check if there's an error in the analysis data
            if (data.error) {
                resultsContent.innerHTML = `
                    <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                        <h4 class="font-bold text-red-800">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                        <p class="mt-2">${data.error}</p>
                    </div>
                `;
                return;
            }
            
            let html = ``;
            
            // Contract Summary
            if (data.contract_summary) {
                html += `
                    <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h4 class="font-bold text-green-800">ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù‚Ø¯</h4>
                        <p class="mt-2 text-green-700">${data.contract_summary}</p>
                    </div>
                `;
            }
            
            // Contract Type
            if (data.contract_type) {
                const contractType = typeof data.contract_type === 'string' ? data.contract_type : 
                                   typeof data.contract_type === 'object' ? JSON.stringify(data.contract_type) :
                                   String(data.contract_type);
                html += `
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-bold text-blue-800">ğŸ“„ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯</h4>
                        <p class="mt-2 text-blue-700">${contractType}</p>
                    </div>
                `;
            }
            
            // Main Parties
            if (data.main_parties) {
                html += `
                    <div class="mb-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <h4 class="font-bold text-purple-800">ğŸ‘¥ Ø£Ø·Ø±Ø§Ù Ø§Ù„Ø¹Ù‚Ø¯</h4>
                        <div class="mt-2 text-purple-700">
                `;
                Object.entries(data.main_parties).forEach(([key, value]) => {
                    const arabicKey = key === 'employer' ? 'ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„' : 
                                     key === 'employee' ? 'Ø§Ù„Ù…ÙˆØ¸Ù' : 
                                     key === 'party1' ? 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„' : 
                                     key === 'party2' ? 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                                     key === 'seller' ? 'Ø§Ù„Ø¨Ø§Ø¦Ø¹' :
                                     key === 'buyer' ? 'Ø§Ù„Ù…Ø´ØªØ±ÙŠ' :
                                     key === 'landlord' ? 'Ø§Ù„Ù…Ø¤Ø¬Ø±' :
                                     key === 'tenant' ? 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±' :
                                     key === 'client' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' :
                                     key === 'service_provider' ? 'Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø©' :
                                     key === 'contractor' ? 'Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„' :
                                     key === 'company' ? 'Ø§Ù„Ø´Ø±ÙƒØ©' : key;
                    html += `<p><strong>${arabicKey}:</strong> ${value}</p>`;
                });
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Key Rights
            if (data.key_rights) {
                html += `
                    <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h4 class="font-bold text-green-800">âœ… Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                        <div class="mt-2">
                `;
                Object.entries(data.key_rights).forEach(([party, rights]) => {
                    const arabicParty = party === 'employer' ? 'ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„' : 
                                       party === 'employee' ? 'Ø§Ù„Ù…ÙˆØ¸Ù' : 
                                       party === 'party1' ? 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„' : 
                                       party === 'party2' ? 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                                       party === 'seller' ? 'Ø§Ù„Ø¨Ø§Ø¦Ø¹' :
                                       party === 'buyer' ? 'Ø§Ù„Ù…Ø´ØªØ±ÙŠ' :
                                       party === 'landlord' ? 'Ø§Ù„Ù…Ø¤Ø¬Ø±' :
                                       party === 'tenant' ? 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±' :
                                       party === 'client' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' :
                                       party === 'service_provider' ? 'Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø©' :
                                       party === 'contractor' ? 'Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„' :
                                       party === 'company' ? 'Ø§Ù„Ø´Ø±ÙƒØ©' : party;
                    html += `
                        <div class="mb-4">
                            <h5 class="font-semibold text-green-700 mb-2">${arabicParty}:</h5>
                            <ul class="list-disc list-inside text-green-600 space-y-1">
                    `;
                    rights.forEach(right => {
                        html += `<li>${right}</li>`;
                    });
                    html += `
                            </ul>
                        </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Key Obligations
            if (data.key_obligations) {
                html += `
                    <div class="mb-6 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                        <h4 class="font-bold text-orange-800">ğŸ“‹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                        <div class="mt-2">
                `;
                Object.entries(data.key_obligations).forEach(([party, obligations]) => {
                    const arabicParty = party === 'employer' ? 'ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„' : 
                                       party === 'employee' ? 'Ø§Ù„Ù…ÙˆØ¸Ù' : 
                                       party === 'party1' ? 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„' : 
                                       party === 'party2' ? 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                                       party === 'seller' ? 'Ø§Ù„Ø¨Ø§Ø¦Ø¹' :
                                       party === 'buyer' ? 'Ø§Ù„Ù…Ø´ØªØ±ÙŠ' :
                                       party === 'landlord' ? 'Ø§Ù„Ù…Ø¤Ø¬Ø±' :
                                       party === 'tenant' ? 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±' :
                                       party === 'client' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' :
                                       party === 'service_provider' ? 'Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø©' :
                                       party === 'contractor' ? 'Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„' :
                                       party === 'company' ? 'Ø§Ù„Ø´Ø±ÙƒØ©' : party;
                    html += `
                        <div class="mb-4">
                            <h5 class="font-semibold text-orange-700 mb-2">${arabicParty}:</h5>
                            <ul class="list-disc list-inside text-orange-600 space-y-1">
                    `;
                    obligations.forEach(obligation => {
                        html += `<li>${obligation}</li>`;
                    });
                    html += `
                            </ul>
                        </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Important Terms
            if (data.important_terms && data.important_terms.length > 0) {
                html += `
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-bold text-blue-800">â­ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ù‡Ù…Ø©</h4>
                        <ul class="mt-2 list-disc list-inside text-blue-700 space-y-1">
                `;
                data.important_terms.forEach(term => {
                    html += `<li>${term}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            // Assessment-specific fields
            // Overall Score and Grade
            if (data.overall_score !== undefined || data.contract_grade) {
                html += `
                    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h4 class="font-bold text-yellow-800">ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h4>
                        <div class="mt-2 text-yellow-700">
                `;
                if (data.overall_score !== undefined) {
                    html += `<p><strong>Ø§Ù„Ù†Ù‚Ø§Ø·:</strong> ${data.overall_score}/10</p>`;
                }
                if (data.contract_grade) {
                    html += `<p><strong>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±:</strong> ${data.contract_grade}</p>`;
                }
                if (data.risk_level) {
                    html += `<p><strong>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±:</strong> ${data.risk_level}</p>`;
                }
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Strengths
            if (data.strengths && data.strengths.length > 0) {
                html += `
                    <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h4 class="font-bold text-green-800">âœ… Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©</h4>
                        <ul class="mt-2 list-disc list-inside text-green-700 space-y-1">
                `;
                data.strengths.forEach(strength => {
                    html += `<li>${strength}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            // Weaknesses
            if (data.weaknesses && data.weaknesses.length > 0) {
                html += `
                    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <h4 class="font-bold text-red-800">âš ï¸ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù</h4>
                        <ul class="mt-2 list-disc list-inside text-red-700 space-y-1">
                `;
                data.weaknesses.forEach(weakness => {
                    html += `<li>${weakness}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            // Legal Compliance
            if (data.legal_compliance) {
                html += `
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-bold text-blue-800">âš–ï¸ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ</h4>
                        <div class="mt-2 text-blue-700">
                `;
                if (data.legal_compliance.score !== undefined) {
                    html += `<p><strong>Ø§Ù„Ù†Ù‚Ø§Ø·:</strong> ${data.legal_compliance.score}/10</p>`;
                }
                if (data.legal_compliance.notes) {
                    html += `<p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${data.legal_compliance.notes}</p>`;
                }
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Financial Risks
            if (data.financial_risks && data.financial_risks.length > 0) {
                html += `
                    <div class="mb-6 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                        <h4 class="font-bold text-orange-800">ğŸ’° Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
                        <ul class="mt-2 list-disc list-inside text-orange-700 space-y-1">
                `;
                data.financial_risks.forEach(risk => {
                    html += `<li>${risk}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            // Legal Risks
            if (data.legal_risks && data.legal_risks.length > 0) {
                html += `
                    <div class="mb-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <h4 class="font-bold text-purple-800">âš–ï¸ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</h4>
                        <ul class="mt-2 list-disc list-inside text-purple-700 space-y-1">
                `;
                data.legal_risks.forEach(risk => {
                    html += `<li>${risk}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            // Recommendations
            if (data.recommendations && data.recommendations.length > 0) {
                html += `
                    <div class="mb-6 p-4 bg-teal-50 border border-teal-200 rounded-lg">
                        <h4 class="font-bold text-teal-800">ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª</h4>
                        <ul class="mt-2 list-disc list-inside text-teal-700 space-y-1">
                `;
                data.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            // Priority Issues
            if (data.priority_issues && data.priority_issues.length > 0) {
                html += `
                    <div class="mb-6 p-4 bg-pink-50 border border-pink-200 rounded-lg">
                        <h4 class="font-bold text-pink-800">ğŸš¨ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø°Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</h4>
                        <ul class="mt-2 list-disc list-inside text-pink-700 space-y-1">
                `;
                data.priority_issues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            // Fields that should appear ONLY for assessment agent
            // Be very strict - only show for explicit assessment type
            const isAssessmentAnalysis = metadata.analysis_type === 'assessment';
            
            // Only show these fields for assessment analysis (NOT for explanation)
            if (isAssessmentAnalysis) {
                // Potential Risks
                if (data.potential_risks && data.potential_risks.length > 0) {
                    html += `
                        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <h4 class="font-bold text-red-800">âš ï¸ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©</h4>
                            <ul class="mt-2 list-disc list-inside text-red-700 space-y-1">
                    `;
                    data.potential_risks.forEach(risk => {
                        html += `<li>${risk}</li>`;
                    });
                    html += `
                            </ul>
                        </div>
                    `;
                }
                
                // Overall Assessment
                if (data.overall_assessment) {
                    const assessment = typeof data.overall_assessment === 'string' ? data.overall_assessment : 
                                     typeof data.overall_assessment === 'object' ? JSON.stringify(data.overall_assessment) :
                                     String(data.overall_assessment);
                    html += `
                        <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <h4 class="font-bold text-gray-800">ğŸ“Š Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…</h4>
                            <p class="mt-2 text-gray-700">${assessment}</p>
                        </div>
                    `;
                }
                
                // Memory Recommendations
                if (data.memory_recommendations && data.memory_recommendations.length > 0) {
                    html += `
                        <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                            <h4 class="font-bold text-indigo-800">ğŸ§  ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©</h4>
                            <ul class="mt-2 list-disc list-inside text-indigo-700 space-y-1">
                    `;
                    data.memory_recommendations.forEach(rec => {
                        html += `<li>${rec}</li>`;
                    });
                    html += `
                            </ul>
                        </div>
                    `;
                }
            }
            
            // Memory Context (for explanation agent only - when it's NOT an assessment)
            if (data.memory_context && !isAssessmentAnalysis) {
                html += `
                    <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <h4 class="font-bold text-indigo-800">ğŸ§  Ø³ÙŠØ§Ù‚ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h4>
                        <div class="mt-2 text-indigo-700">
                            ${typeof data.memory_context === 'object' ? 
                              Object.entries(data.memory_context).map(([key, value]) => 
                                `<p><strong>${key}:</strong> ${value}</p>`
                              ).join('') : 
                              `<p>${data.memory_context}</p>`
                            }
                        </div>
                    </div>
                `;
            }
            
            // Fallback for any other content
            if (!data.contract_summary && !data.key_rights && !data.key_obligations && 
                !data.overall_score && !data.strengths && !data.recommendations && 
                !data.potential_risks && !data.overall_assessment && data.content) {
                html += `
                    <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <h4 class="font-bold text-gray-800">ğŸ“„ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</h4>
                        <div class="mt-2 text-gray-700 whitespace-pre-wrap">${data.content}</div>
                    </div>
                `;
            }
            
            resultsContent.innerHTML = html;
            
            // Show chat section if explanation agent was used
            if (metadata.analysis_type === 'explanation') {
                document.getElementById('chatSection').classList.remove('hidden');
            }
        }
        
        // Global variables for chat
        let currentContractText = '';
        let currentSessionId = '';
        let currentUserId = '';
        
        // Chat functionality
        async function askQuestion() {
            const questionInput = document.getElementById('chatInput');
            const question = questionInput.value.trim();
            const chatMessages = document.getElementById('chatMessages');
            const askButton = document.getElementById('askButton');
            
            if (!question) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø³Ø¤Ø§Ù„');
                return;
            }
            
            if (!currentContractText) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Clear input and disable button
            questionInput.value = '';
            askButton.disabled = true;
            askButton.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
            
            // Add user question to chat
            addChatMessage('user', question);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        contract_text: currentContractText,
                        user_id: currentUserId,
                        session_id: currentSessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Parse agent response
                    let agentAnswer;
                    try {
                        // Handle the new clean response format from Lambda
                        if (result.result && typeof result.result === 'object') {
                            // Check if it has content field
                            if (result.result.content) {
                                agentAnswer = result.result.content;
                            } else {
                                // Format structured response nicely
                                agentAnswer = formatChatResponse(result.result);
                            }
                        } else if (result.result && typeof result.result === 'string') {
                            agentAnswer = result.result;
                        } else {
                            agentAnswer = 'Ù„Ù… Ø£Ø³ØªØ·Ø¹ ÙÙ‡Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØªÙ‡.';
                        }
                    } catch (parseError) {
                        console.error('Parse error:', parseError);
                        agentAnswer = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.';
                    }
                    
                    addChatMessage('agent', agentAnswer);
                } else {
                    addChatMessage('agent', `Ø®Ø·Ø£: ${result.error || 'Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„'}`);
                }
                
            } catch (error) {
                addChatMessage('agent', `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`);
            } finally {
                askButton.disabled = false;
                askButton.textContent = 'â“ Ø§Ø³Ø£Ù„';
            }
        }
        
        // Format chat response from JSON to readable Arabic text
        function formatChatResponse(data) {
            let formattedText = '';
            
            // Handle contract benefits
            if (data.contract_benefits) {
                formattedText += 'ğŸ¯ **ÙÙˆØ§Ø¦Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯:**\n\n';
                
                if (data.contract_benefits.legal_protection) {
                    formattedText += 'âš–ï¸ **Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©:**\n';
                    data.contract_benefits.legal_protection.forEach(item => {
                        formattedText += `â€¢ ${item}\n`;
                    });
                    formattedText += '\n';
                }
                
                if (data.contract_benefits.financial_clarity) {
                    formattedText += 'ğŸ’° **Ø§Ù„ÙˆØ¶ÙˆØ­ Ø§Ù„Ù…Ø§Ù„ÙŠ:**\n';
                    data.contract_benefits.financial_clarity.forEach(item => {
                        formattedText += `â€¢ ${item}\n`;
                    });
                    formattedText += '\n';
                }
                
                if (data.contract_benefits.dispute_prevention) {
                    formattedText += 'ğŸ›¡ï¸ **Ù…Ù†Ø¹ Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª:**\n';
                    data.contract_benefits.dispute_prevention.forEach(item => {
                        formattedText += `â€¢ ${item}\n`;
                    });
                    formattedText += '\n';
                }
                
                if (data.contract_benefits.legal_reference) {
                    formattedText += 'ğŸ“‹ **Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©:**\n';
                    data.contract_benefits.legal_reference.forEach(item => {
                        formattedText += `â€¢ ${item}\n`;
                    });
                    formattedText += '\n';
                }
                
                if (data.contract_benefits.ownership_transfer) {
                    formattedText += 'ğŸ”„ **Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©:**\n';
                    data.contract_benefits.ownership_transfer.forEach(item => {
                        formattedText += `â€¢ ${item}\n`;
                    });
                    formattedText += '\n';
                }
                
                if (data.contract_benefits.practical_benefits) {
                    formattedText += 'âœ… **Ø§Ù„ÙÙˆØ§Ø¦Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:**\n';
                    data.contract_benefits.practical_benefits.forEach(item => {
                        formattedText += `â€¢ ${item}\n`;
                    });
                    formattedText += '\n';
                }
            }
            
            // Handle recommendations
            if (data.recommendations) {
                formattedText += 'ğŸ’¡ **Ø§Ù„ØªÙˆØµÙŠØ§Øª:**\n';
                data.recommendations.forEach(item => {
                    formattedText += `â€¢ ${item}\n`;
                });
                formattedText += '\n';
            }
            
            // Handle contract importance
            if (data.contract_importance) {
                formattedText += 'â­ **Ø£Ù‡Ù…ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯:**\n';
                Object.entries(data.contract_importance).forEach(([key, value]) => {
                    const arabicKey = key === 'legal_aspects' ? 'Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©' :
                                     key === 'protection' ? 'Ø§Ù„Ø­Ù…Ø§ÙŠØ©' :
                                     key === 'clarity' ? 'Ø§Ù„ÙˆØ¶ÙˆØ­' : key;
                    formattedText += `â€¢ **${arabicKey}:** ${value}\n`;
                });
            }
            
            // If no specific structure found, try to format general content
            if (!formattedText) {
                if (typeof data === 'string') {
                    return data;
                } else if (data.content) {
                    return data.content;
                } else {
                    // General JSON formatting
                    formattedText = 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:\n\n';
                    Object.entries(data).forEach(([key, value]) => {
                        if (Array.isArray(value)) {
                            formattedText += `**${key}:**\n`;
                            value.forEach(item => formattedText += `â€¢ ${item}\n`);
                            formattedText += '\n';
                        } else if (typeof value === 'object') {
                            formattedText += `**${key}:**\n`;
                            Object.entries(value).forEach(([subKey, subValue]) => {
                                formattedText += `  - ${subKey}: ${subValue}\n`;
                            });
                            formattedText += '\n';
                        } else {
                            formattedText += `**${key}:** ${value}\n\n`;
                        }
                    });
                }
            }
            
            return formattedText || 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙˆÙ„ÙƒÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.';
        }
        
        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 ${sender === 'user' ? 'text-right' : 'text-left'}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="inline-block bg-blue-600 text-white p-3 rounded-lg max-w-xs">
                        <strong>Ø£Ù†Øª:</strong> ${message}
                    </div>
                `;
            } else {
                // Format the message for better display
                const formattedMessage = message
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
                    .replace(/\n/g, '<br>') // Line breaks
                    .replace(/â€¢/g, 'â€¢'); // Ensure bullet points display
                
                messageDiv.innerHTML = `
                    <div class="inline-block bg-gray-200 text-gray-800 p-3 rounded-lg max-w-lg" style="white-space: pre-line;">
                        <strong>ğŸ¤– Ø§Ù„ÙˆÙƒÙŠÙ„:</strong><br>${formattedMessage}
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Remove the placeholder message if it exists
            const placeholder = chatMessages.querySelector('.text-center.text-gray-500');
            if (placeholder) {
                placeholder.remove();
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Make status check non-blocking and run asynchronously
            setTimeout(() => {
                checkSystemStatus();
            }, 100);
        });
    </script>
</body>
</html>